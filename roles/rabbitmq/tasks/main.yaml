# - name: configure yum erlang repos
#   ansible.builtin.shell: curl -s https://packagecloud.io/install/repositories/rabbitmq/erlang/script.rpm.sh | bash

# - name: configure yum rabbitmq repos
#   ansible.builtin.shell: curl -s https://packagecloud.io/install/repositories/rabbitmq/rabbitmq-server/script.rpm.sh | bash

# - name: install rabbitmq server
#   ansible.builtin.dnf:
#     name: rabbitmq-server
#     state: present

# - name: start and enable rabbitmq
#   ansible.builtin.service:
#     name: rabbitmq-server
#     state: restarted
#     enabled: yes

# - name: create rabbitmq user
#   community.rabbitmq.rabbitmq_user:
#     user: "{{ lookup('aws_ssm', '/roboshop/{{env}}/rabbitmq_user', region='us-east-1', decrypt=True ) }}"
#     password: "{{ lookup('aws_ssm', '/roboshop/{{env}}/rabbitmq_password', region='us-east-1', decrypt=True ) }}"
#     vhost: /
#     configure_priv: .*
#     read_priv: .*
#     write_priv: .*
#     state: present



# CHATGPT 

- name: Download Erlang YUM repo script
  ansible.builtin.get_url:
    url: https://packagecloud.io/install/repositories/rabbitmq/erlang/script.rpm.sh
    dest: /tmp/erlang_repo.sh
    mode: '0755'

- name: Configure Erlang YUM repository
  ansible.builtin.command: bash /tmp/erlang_repo.sh
  args:
    creates: /etc/yum.repos.d/rabbitmq_erlang.repo  # Adjust if actual path differs

- name: Download RabbitMQ YUM repo script
  ansible.builtin.get_url:
    url: https://packagecloud.io/install/repositories/rabbitmq/rabbitmq-server/script.rpm.sh
    dest: /tmp/rabbitmq_repo.sh
    mode: '0755'

- name: Configure RabbitMQ YUM repository
  ansible.builtin.command: bash /tmp/rabbitmq_repo.sh
  args:
    creates: /etc/yum.repos.d/rabbitmq_rabbitmq-server.repo  # Adjust if actual path differs

- name: Install RabbitMQ server
  ansible.builtin.dnf:
    name: rabbitmq-server
    state: present

- name: Enable and start RabbitMQ service
  ansible.builtin.service:
    name: rabbitmq-server
    state: started
    enabled: yes

- name: Create RabbitMQ user
  vars:
    rabbitmq_user_param: "/roboshop/{{ env }}/rabbitmq_user"
    rabbitmq_pass_param: "/roboshop/{{ env }}/rabbitmq_password"
  community.rabbitmq.rabbitmq_user:
    user: "{{ lookup('aws_ssm', rabbitmq_user_param, region='us-east-1', decrypt=True) }}"
    password: "{{ lookup('aws_ssm', rabbitmq_pass_param, region='us-east-1', decrypt=True) }}"
    vhost: /
    configure_priv: .*
    read_priv: .*
    write_priv: .*
    state: present
